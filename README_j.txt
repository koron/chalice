Chalice 〜2ちゃんねる閲覧プラグイン for Vim〜 取扱説明書
                                                             since 16-Nov-2001
                                                                   Version 1.0
                                                         Muraoka Taoro (KoRoN)
                                                     Last Change: 27-Dec-2001.

説明
  Vim上で2ちゃんねるの掲示板を閲覧するためのプラグインです。Vimさえ動くのであ
  ればどのOSでも同じように操作することができます。Chaliceは「片手でキーボード
  のみで使える」ことを基本設計方針にしています。

  # 以下の文中ではVim,vim,gvim等など、幾つか違った表記が現れますがどれも同じ
  # Vimとして考えてください。
  
  ChaliceはcURLを使用してスレデータを取得しています。cURLを持ってない方は別途
  入手してください。Windowsでは下記のcurl.exeバイナリをダウンロードします。
  UNIXではソースを持ってきてコンパイル・インストールしてください。Mac OS Xでは
  最初からインストールされています(10.1以降)。

  UNIXで使用するにはvimを+iconvでコンパイルしておく必要があります。またiconvだ
  けでは文字コード変換に対応しきれないため、別途に文字コード変換外部プログラム
  qkcかnkfが必要となります。特に変換精度の良さからqkcを推奨します。下記のサイ
  トよりソースをダウンロードしてインストールしてください。

  - curl.exe
    http://www.kaoriya.net/testdir/curl-7.9.1-w32.tar.bz2

  - cURLのサイト(ソース他)
    http://curl.sourceforge.net/

  - qkcのサイト(ソース)
    http://hp.vector.co.jp/authors/VA000501/index.html

  Chaliceは「チャリス」と発音します。辞書をひけば「杯・聖杯」という意味になり
  ます。開発コードを「Alice」にしたかったという単純な動機から、ちょっとヒネろ
  うかと/\caliceで辞書を検索したところ、今の名前がひっかかりました。2chのブラ
  ウザということもあり、語呂も良さそうなのでChaliceに決定しました。そんな経緯
  の名前なので「ちゃんねるアリス」とか「アリスちゃん」とか、呼びやすい名前で呼
  んでもらっても結構です。もっと良い名前があったら変えちゃうかもしれません。

  なおスレッドを立てることはできません

インストール
  (Windows お手軽インストール)
    解凍してでてきたディレクトリ chalice-{バージョン名} を vimfiles に変更し、
    curl.exeと一緒にgvim.exeと同じディレクトリへコピーする。このとき既に同名の
    ファイル・ディレクトリが存在する場合には上書きしてしまってよい。あとはVim
    起動後に
      :Chalice
    とタイプすればプラグインが起動する。インストールは簡単だけどアンインストー
    ルが面倒になる、諸刃の剣。

  (Windows 普通のインストール)
    1. 解凍して出来たディレクトリを適当な場所に置きます。
       ここでは説明のために chalice-{バージョン名} というディレクトリをchalice
       に変更し、gvim.exeと同じディレクトリに置いたとします。
    2. curl.exeを環境変数PATHのどこかにコピーしてください。
       よくわからない場合はgvim.exeと同じディレクトリで良いです。
    3. vimを起動して次のようにタイプします。
       :set runtimepath+=$VIM/chalice
       :runtime plugin/chalice.vim
       :Chalice
    4. 必要ならば個人設定ファイル _vimrc に
         set runtimepath+=$VIM/chalice
       と記述しておけばVimを起動した後
         :Chalice
       とタイプするだけでプラグインが起動します。

  (UNIXお手軽インストール)
    インストールスクリプトを作成しました。以下のようにインストール可能です。
      > su ; sh ./install.sh
    $VIMRUNTIMEらしいところにvimfilesを作って必要なファイルをコピーしているだ
    けです。その他にcURLとqkcもしくはnkfのインストールを忘れないで下さい。

  (UNIX手動インストール)
    基本的に(Windows 普通のインストール)と同じ方法でインストールが可能です。た
    だしcURLのインストールと、及びqkcもしくはnkf(qkc推奨)のインストールを忘れ
    ないで下さい。

  (Mac OS X お手軽インストール)
    解凍してでてきたディレクトリ chalice-{バージョン名} を vimfiles に変更し、
    Vim実行ファイルのあるディレクトリにコピーする。このとき既に同名のディレク
    トリが存在する場合には上書きしてしまってよい。あとはVim起動後に
      :Chalice
    とタイプすればプラグインが起動する。インストールは簡単だけどアンインストー
    ルが面倒になる、諸刃の剣。

  (Mac OS X 普通のインストール)
    1. 解凍して出来たディレクトリを適当な場所に置きます。
       ここでは説明のために chalice-{バージョン名} というディレクトリをchalice
       に変更し、Vimのアイコンと同じディレクトリに置いたとします。
    2. vimを起動して次のようにタイプします。
       :set runtimepath+=$VIM/chalice
       :runtime plugin/chalice.vim
       :Chalice
    3. 必要ならば個人設定ファイル $VIM/_vimrc に
         set runtimepath+=$VIM/chalice
       と記述しておけばVimを起動した後
         :Chalice
       とタイプするだけでプラグインが起動します。

操作法
  - (起動方法)  :Chalice

  閲覧系バッファ
  - (全共通)    q       Chaliceを終了
  - (全共通)    Q       Vimもすべて終了
  - (全共通)    R       現在のバッファをリロード
  - (全共通)    <C-Tab> バッファ間移動(<S-Tab>で逆順)
  - (全共通)    <BS>    板一覧へ移動
  - (全共通)    u       スレ一覧(栞)へ移動
  - (全共通)    U       スレ一覧(栞)へ移動(+栞の起動トグル)
  - (全共通)    m       スレッドへ移動
  - (全共通)    M       スレッドへ移動(+栞の起動トグル)
  - (全共通)    <C-A>   スレの栞(ブックマーク)の起動・終了トグル
  - (全共通)    <Space> 1画面スクロールダウン(<S-Space>及びpでアップ)
  - (全共通)    <C-N>   クリップボードのURLをChaliceで開く

  - (板一覧)    j,k     カテゴリ・板の選択(カーソル移動による)
  - (板一覧)    h,l     カテゴリfoldを閉じる(h)・開く(l)
  - (板一覧)    <CR>    カテゴリfoldの開閉・閲覧する板の決定
  - (板一覧)    <S-CR>  板を外部ブラウザで開く

  - (スレ一覧)  j,k     スレを選択(カーソル移動による)
  - (スレ一覧)  d       スレのキャッシュdatを(存在すれば)削除
  - (スレ一覧)  <CR>    閲覧するスレの決定(<C-CR>で先頭から)
  - (スレ一覧)  <S-CR>  スレを外部ブラウザで開く
  - (スレ一覧)  ~       カーソル行のスレを栞に登録

  - (スレッド)  j,k     カーソル上下移動
  - (スレッド)  h,l     カーソル上下移動
  - (スレッド)  J,K     1行スクロールダウン/アップ
  - (スレッド)  p       1画面スクロールアップ
  - (スレッド)  <,>     前/次の記事へ移動(, と .も同じ意味)
  - (スレッド)  <CR>    カーソル行の記事/URLを開く(Chalice優先)
  - (スレッド)  <S-CR>  カーソル行の記事/URLを外部ブラウザで開く
  - (スレッド)  <C-O>   <CR>ジャンプを遡る(<C-I>で順方向ジャンプ)
  - (スレッド)  r       現在のスレを更新(差分更新のため高速:推奨)
  - (スレッド)  ~       閲覧中のスレをスレの栞に登録

  - (スレの栞)  j,k     カーソル上下移動
  - (スレの栞)  h,l     カテゴリfoldを閉じる(h)・開く(l)
  - (スレの栞)  <CR>    カテゴリfold開閉・閲覧するスレの決定

  スレ一覧では一度でも読んだことのある(ローカルにdatファイルが存在する)スレに
  印が付きます。印には ! と + の2種類があり、! は過去chalice_threadinfo_expire
  秒以内にローカルのdatファイルが更新されたものを、+ は更新されていないものを
  意味します。

  スレの栞はテキストファイルのように編集可能です。カテゴリを作成するには先頭が
  「■」で始まる行を書きます。栞の内容は閉じるたびに自動的にファイルへ保存され
  ます。保存ファイルを知るには次のコマンドを使ってください。
        :echo chalice_bookmark

  書き込み系バッファ
  - (書き込み)  i,I     書き込みモードへ(Iはsage/o,Oも同じ意味)
  - (書き込み)  a,A     匿名書き込みモードへ(Aはsage)
  - (書き込み)  <C-CR>  書き込み実行

  書込む内容に不備がなければ直前に書込むかどうか最後の確認を求められる。本当に
  書込んでよければ yes とタイプ。no とタイプした時には書き込みは行なわれずバッ
  ファの内容が失われる。書き込みを中断するには cancel (デフォルト)。

  知って得する基本操作
  - (folding)   zr      全fold展開
  - (folding)   zm      全fold閉鎖

便利な設定・裏技 (+ は1.0以降に追加/変更のあった項目)
  ゆかいな設定変数たち
  - chalice_username                    書き込み時に自動入力するユーザ名
    例:   let chalice_username = 'KoRoN@Vim%Chalice'

  - chalice_anonyname                   匿名書き込み時に自動入力するユーザ名
    例:   let chalice_anonyname = '名無しさん@Vim%Chalice'

  - chalice_usermail                    書き込み時に自動入力するメールアドレス
    例:   let chalice_usermail = 'koron@tka.att.ne.jp'

  - chalice_columns                     Chalice起動時の'columns'を設定
    例:   let chalice_columns = 160
    (解説)Chalice起動時に'columns'を160に設定する。

  - chalice_bookmark                    ブックマークファイルを記憶
    例:   echo chalice_bookmark
    (解説)ブックマークファイル名を確認する。
    例:   let chalice_bookmark = $HOME . '/.chalice_bmk'
    (解説)ブックマークファイルを指定する。

  - chalice_jumpmax                     ジャンプ履歴の最大サイズ(省略値:100)
    例:   let chalice_jumpmax = 1000

  - chalice_curl_options                cURLに渡すオプション
    例:   let chalice_curl_options = '-x {host}:{port}'
    (解説)プロキシの設定をする(詳細はcURLの文章を参照)。

  - chalice_exbrowser                   外部ブラウザを指定(非Windowsのみ)
    例:   let chalice_exbrowser = 'netscape %URL% &'
    (解説)文字列中の %URL% はURLに置き換えられる。

  - chalice_reloadinterval_boardlist    板一覧のリロード間隔(秒)
    例:   let chalice_reloadinterval_boardlist = 604800

  - chalice_reloadinterval_threadlist   スレ一覧のリロード間隔(秒)
    例:   let chalice_reloadinterval_threadlist = 0
    (解説)スレ一覧の取得間隔を0秒(常に更新)にする。

  + chalice_threadinfo		        鮮度表示機能フラグ
    例:   let chalice_threadinfo = 0
    (解説)スレのdatファイルの存在・更新状況の表示機能を無効にする。

  + chalice_threadinfo_expire		鮮度保持期間(秒)
    例:   let chalice_threadinfo_expire = 7200
    (解説)既読かつ2時間以上更新されていないスレを強調表示する。

  - chalice_gzip                        gzip圧縮の有無効フラグ
    例:   let chalice_gzip = 0
    (解説)gzip圧縮転送機能がエラーを起こす際に0を設定し、これを無効とする。

  - chalice_multiuser                   マルチユーザモード(UNIXはデフォルト)
    例:   let chalice_multiuser = 1

  - chalice_verbose                     動作情報の報告レベル(デバッグ用)
    例:   let chalice_verbose = 1
    (解説)1以上に設定すると外部コマンドの実行状況を観察できる。

  裏とは言えない技
  - 'I'で書き込みモードに入るとchalice_usermailに関わらず"sage"に
  - 'a'で書き込みモードに入るとchalice_usernameに関わらず「名無し」に
  - 'A'で書き込みモードに入ると強制的に「名無し」「sage」に
  - 実は"y"だけでも書き込める
  - :ChaliceJumplistでジャンプの履歴を参照可
  - :ChaliceGoArticle 番号で指定された記事番号へジャンプ

問題点
  解決する意思はある(上にあるものほど優先順位が高いかも)
  - URL中のlによる部分的な表示に未対応
  - 古い書き込みのfolding等ができない…仕様が固まればやる

  こっちは仕様(仕方ないとか、要らないとか)
  - 古い形式(read.cgi?bbs=...)は未サポート
  - 9xでのブラウザ起動は動作チェックしていない(誰か使ってくれてるよね?)
  - UNIXで「◆Vim6 2」だけを栞登録すると化ける←文字コード上致し方なし
  - UNIXからの書き込みにはiconvが必要→無いと化ける。
  - あぼ〜ん対策が弱い→<C-R>の強制リロードで対応可能
  - スレッドを建てられない…というよりもプロトコルが一定でないので保留
  - AAがズレる

使用許諾・免責
  Vimを使って2chを見たいという欲求が強い人しか使ってはいけません。というより使
  わないハズです。改良案がある人は遠慮しないで連絡してください。特にパッチは大
  歓迎です。要望だけだと必ずしも満たすことは保証できかねます。

  このソフトウェアを使用したことへの対価は要求しません。このソフトウェアを使用
  したために生じた損害については一切補償いたしません。著作権は放棄しません。転
  載・再配布の際は事後で構わないので連絡をください。

質問・連絡先
  Vim掲示板・もしくはメールでお願いします。

  - Vim掲示板
    http://www.kaoriya.net/bbs/bbs.cgi

  - 村岡のemailアドレス
    koron@tka.att.ne.jp

  - 2ch/ソフトウェア板/2ch閲覧プラグイン〜Chalice fro Vim
    http://pc.2ch.net/test/read.cgi/software/1006852780/l50
  - 2ch/Unix板/◆Vim6 2
    http://pc.2ch.net/test/read.cgi/unix/1006246205/l50

謝辞
  - Chalice/vim6スレの住人さん達
  - ハートに火を点けてくれた「まっつん」こと松本さん
  - そしてVimの作者Bram Moolenaar氏
  以上の方々に感謝。

更新履歴
  ● 27-Dec-2001 (1.1 正式版)
    BBSMENUのフォーマット方法を見直し(Rでリロード)
    ドキュメント更新
    'chalice_columns'を追加
  ● 19-Dec-2001 (1.1a-beta)
    スレッドにfoldcolumn=1を指定
    URLによるレンジ指定(100-123の形式)に対応(using fold)
    URLのエスケープがNT系でしか有効でなかったのを修正
    URLを外部ブラウザで開く前に#をエスケープ(バッファ名への展開を抑制)
    2ch URLでジャンプした時にジャンプ元をヒストリに記憶
    compress GET時に、proxyオプションととかが無効になってしまう件の修正
    URLを外部ブラウザで開く前に%をエスケープ(バッファ名への展開を抑制)
    スレdatの消去機能/情報表示更新を追加
    マニュアル表記修正
    書き込みバッファシンタックスのURL構成文字に","を追加
    スレのdatの増分の位置から表示するように変更(UNIXでは正常動作しないかも)
    板リロードタイムのデフォルトを30分に変更
    スレ一覧にスレdatファイル情報を表示(これって既読/未読情報?)
    'p'にバックスクロール(栞/書き込み以外)
    起動時に'scrolloff'を0にする
    ジャンプ履歴をスクリーンベースにして賢くなるよう改良
    ジャンプ履歴にスレタイトル(コメント)項目を追加
    NT/2KでURLに&を含む場合のワークアラウンドを追加

  ● 25-Nov-2001 (1.0 正式版)
    <Tab>のバッファ変更を<C-Tab> (人によってこれは痛いかも)
    独自のジャンプリストを作成(ジャンプ先がChaliceから外れて死亡、を回避)
    整形中の消去内容がレジスタに入らないように
    gzip非対応サーバだった場合を考慮
    匿名書き込み時のユーザ名設定変数(chalice_anonyname)追加
    明示的な書き込みキー(<C-CR>)+キャンセル(迂回手段)を追加
    栞からスレ一覧に戻る時に極力行数を覚えておく
    栞データファイル名の検索方法を変更
    command.comの起動方法を変更(""で括るのはcmd.exe使用時に限定)
    キー操作のマイナーチェンジ
    gzip転送に対応
  ● 22-Nov-2001 (1.0j-rc2)
    いよいよコードfix間近です
    非Windows環境に外部ブラウザ起動の機会を設ける
    ドキュメント大幅校正
    キー割り当ての大幅な見直し
    スレの栞にfoldingの機能を付けた
    OS X版も動くYO!!
    スレデータ解釈のパターンを変更して安定度大幅アップ
    ブックマーク二重登録時のconfirm(まっつん)
    外部コマンドの検索方法と起動文字列の変更
    Winのshellやshellslashしてない環境での動作チェック
  ● 22-Nov-2001 (1.0i-rc1)
    Winのshellやshellslashしてない環境での動作チェック
    Winでのmkdirできない問題を修正
    UNIX(Linux)用簡易インストールスクリプト作成
    インストールに関するドキュメント修正
    マルチユーザ対応
    スレ一覧<C-CR>でスレの先頭を開く機能を実装
    OpenThread()のロジック整理
    スレ一覧での<C-D>でスレ登録
    スレ一覧をnumberに設定
  ● 22-Nov-2001 (1.0h-beta)
    OS X版コケる→諦めます
    <C-H>にもバッファ戻り(スレ→スレ一覧→板一覧)を割り当て
    UNIX用読み込みフィルタを組み込む
    外部コマンドのパスを自力で検索
    ブックマークの起動を<C-A>へ割り当て(<C-S>だとターミナルで困る)
  ● 21-Nov-2001 (1.0g-beta)
    <BS>にバッファ戻り(スレ→スレ一覧→板一覧)を割り当て
    ブックマークの起動を<C-S>へ割り当て
    板一覧では'l'と'h'でカテゴリの開閉
    'h'と'l'を通常の意味に、','と';'をバッファ移動へ割り当て
    ドキュメントの不具合修正(◆Vim6 2スレ>>22)
    書き込み時にCookieでNAMEとMAILを焼く(ラジオ番組板対策)
    書き込みcurlの起動にユーザ定義オプションの前に空白が入ってなかった
    キャッシュディレクトリが無い場合は作成する
    <S-CR>が正常に働かないバグを修正
    ブックマークが消えるバグ修正
    scriptencoding追加→UNIX版はiconvが入っていればコンバートせずともOK
  ● 20-Nov-2001 (1.0f-beta)
    コマンドの登録をダイナミック化(from mattn)
    板一覧をfolding
    cURLに渡すオプションの変数名をg:chalice_curl_optionsへ変更
    外部コマンドの実行方法をコントロール可能に
    ブックマークを実装
    スレの整形を高速化
    (非cp932環境のみ) iconv()で書き込み文字列をcp932へコンバート
    メール欄に名前が入力されてしまうバグ修正
    書き込みスレのタイトルが新スレのものと入れ替わるバグ修正
    ドキュメントの不備を修正
  ● 19-Nov-2001 (1.0e-alpha)
    新スレ作成機能を途中までで中止→建てられなくても良いじゃん?
    板一覧・スレ一覧で<S-CR>を外部ブラウザにバインド
    コンソール時にUnderlinedではなくDirectoryを使うように変更
    shellxquoteにあわせ外部コマンドへ渡すファイル名等をquote
    スレデータ以外のキャッシュに有効期限を設定できるように変更
    リロードのキーバインドを'R'に変更
    書き込みバッファの再利用化・下方設置
    スレの整形を高速化(?)
    undolevels=0によりメモリ節約→高速化
    &nbsp;と&quotに対応
    バッファ使用数を減らす変更
  ● 18-Nov-2001 (1.0d-alpha)
    バッファ1行ヘルプ
    書き込み機能実装
    'wrapscan'を設定
    書き込み実装
    wgetからcURLへの切替
  ● 18-Nov-2001 (1.0c-alpha)
    スレへのリンク機能を強化
    スレのフルリロード/インクリメンタルリロードを実装
    グローバル/ローカルオプションを追加
    URLエンコードルーチンを作成
    外部ブラウザの開き方をNT系のみ信頼性の高いものに変更
    スクロール・板/スレ選択の操作方法を変更
  ● 16-Nov-2001 (1.0b-alpha)
    全てのバッファについて、それぞれリロードできるように改良
    スレ一覧はキャッシュを優先するように変更←動作速度を上げるため
    リンクに飛べるように改良
    ファイルタイププラグインを活用する手法に変更
    要らないメッセージさようなら/時間待ちメッセージこんにちは
    スレ一覧の&lt;等の置換処理追加
    datの保存名に板情報が欠落していたのを修正
    スレのキーバインドを追加・修正
    スレのシンタックスを修正

-------------------------------------------------------------------------------
                  生きる事への強い意志が同時に自分と異なる生命をも尊ぶ心となる
                                   Muraoka Taro/村岡太郎 <koron@tka.att.ne.jp>
 vim:set ts=8 sts=2 sw=2 tw=78 et:
